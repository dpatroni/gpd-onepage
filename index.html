<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GPD – Reporte OnePage</title>

<!-- Chart.js + html2pdf -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --green:#1f3b26; --green-2:#6fbf73; --green-3:#a7d7a9;
    --blue:#2c6cb0; --gray:#6b7280; --light:#f5f7f8;
    --yellow:#ffe54d; --ink:#111;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111;background:#fff}
  .wrap{max-width:1280px;margin:0 auto;padding:28px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:14px}
  .brand h1{margin:0;color:var(--green);font-weight:900;letter-spacing:2px;font-size:52px}
  .sub{font-size:20px;font-weight:800;margin:2px 0}
  .muted{color:var(--gray);font-size:13px}
  .btn{background:#111;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}

  .grid{display:grid;gap:16px}
  .g-3{grid-template-columns:2fr 3fr 3fr}
  .g-2{grid-template-columns:1fr 1fr}
  .g-12{grid-template-columns:7fr 5fr}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  .section-title{font-weight:700;margin-bottom:8px}
  .pill{display:inline-block;background:var(--yellow);padding:8px 10px;border-radius:8px;font-weight:900}

  .chart-box{position:relative;height:300px}
  .center-total{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;text-align:center}
  .center-total .t{font-weight:800;font-size:28px}
  .center-total .s{font-size:12px;color:#444}

  .legend{margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;font-size:12px}
  .item{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}

  .pie-mini{height:240px}

  .list{display:grid;gap:4px;font-size:13px}
  .list .row{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:4px 0}

  .bar-item{display:flex;align-items:center;gap:12px;margin:8px 0}
  .bar{height:18px;background:repeating-linear-gradient(45deg,#d1d5db,#d1d5db 6px,#eceff1 6px,#eceff1 12px);border-radius:6px}

  .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .client-card{border:1px solid #e5e7eb;border-radius:16px;padding:14px;background:#fff}
  .client-card h4{margin:0 0 6px 0}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:12px}
  .kpi-box{background:#f7faf7;border:1px solid #e6eee6;border-radius:10px;padding:8px;text-align:center}
  .kpi-box .v{font-weight:800;font-size:14px}

  .footnote{font-size:12px;color:#666}
  @media(max-width:1100px){
    .g-3,.g-2,.g-12{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap" id="capture">
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <h1>GPD</h1>
      <div>
        <div class="sub">Portafolio GPD a <span id="label-mes">Julio 2025</span></div>
        <div class="muted">(Mill. US$ al <span id="label-fecha">31.07.2025</span>)</div>
      </div>
    </div>
    <button class="btn" id="btn-pdf">Exportar PDF</button>
  </div>

  <!-- Fila superior -->
  <div class="grid g-3">
    <!-- Rentabilidad -->
    <div class="card">
      <div class="section-title">Rentabilidad Anual</div>
      <div>
        <span class="pill" id="rentabilidad-kpi">20.86%</span>
        <div class="muted" style="margin-top:8px">tasa de rentabilidad neta anualizada*</div>
        <div class="muted">*Considerando últimos 12 meses</div>
      </div>
    </div>

    <!-- Estatus Operativo -->
    <div class="card">
      <div class="section-title">Estatus Operativo</div>
      <div class="grid g-2" style="gap:8px;margin-bottom:6px">
        <div class="muted">Jul-25</div><div class="muted" style="text-align:right">Dic-24</div>
      </div>
      <div class="chart-box">
        <canvas id="chartEstatus"></canvas>
        <div class="center-total">
          <div>
            <div class="t" id="total-mm">--</div>
            <div class="s">MM USD</div>
          </div>
        </div>
      </div>
      <div class="legend" id="legendEstatus"></div>
    </div>

    <!-- Distribución por sectores -->
    <div class="card">
      <div class="section-title">Distribución por sectores</div>
      <div class="muted">(Mill. US$ al <span id="label-fecha-2">31.07.2025</span>)</div>
      <div class="chart-box">
        <canvas id="chartSectores"></canvas>
      </div>
      <div class="legend" id="legendSectores"></div>
    </div>
  </div>

  <!-- Segunda franja -->
  <div class="grid g-12" style="margin-top:16px">
    <!-- Clientes Fondo EGQ -->
    <div class="card">
      <div class="section-title">Clientes Fondo EGQ</div>
      <div class="muted" style="margin-bottom:6px">Principales 5 clientes</div>
      <div class="grid g-12">
        <div>
          <div class="chart-box pie-mini">
            <canvas id="chartTopClientes"></canvas>
          </div>
        </div>
        <div>
          <div class="list" id="listaOtrosClientes"></div>
        </div>
      </div>
    </div>

    <!-- Valor Cuota -->
    <div class="card">
      <div class="section-title">Valor Cuota</div>
      <div class="grid g-2" style="gap:12px">
        <div>
          <table class="muted" style="font-size:13px;width:100%">
            <tr><th style="text-align:left">Rent. Neta</th><td style="text-align:right" id="rn-2023">18.6%</td><td style="text-align:right" id="rn-2024">24.8%</td><td style="text-align:right" id="rn-ytd">—</td></tr>
            <tr><th style="text-align:left">Rent. Bruta</th><td style="text-align:right">30.0%</td><td style="text-align:right">30.0%</td><td style="text-align:right">—</td></tr>
          </table>
        </div>
        <div>
          <canvas id="chartValorCuota" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tercera franja: Garantías + Monto Colocado -->
  <div class="grid g-12" style="margin-top:16px">
    <!-- Garantías -->
    <div class="card">
      <div class="section-title">Principales Garantías Reales (miles US$)</div>
      <div class="grid g-2" style="gap:16px">
        <div>
          <div class="list" id="tablaGarantias"></div>
          <div class="card" style="background:#f6fbf6;border-color:#dbe9db;margin-top:10px">
            <strong id="cobertura-kpi">77% de exposición</strong><br>
            <span class="muted">cubierto con garantías reales</span>
          </div>
        </div>
        <div>
          <div class="chart-box pie-mini">
            <canvas id="chartGarantias"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Monto Colocado -->
    <div class="card">
      <div class="section-title">Monto Colocado por cliente (US$)</div>
      <div id="barrasColocado"></div>
    </div>
  </div>

  <!-- Cuarta franja: Info adicional clientes -->
  <div class="card" style="margin-top:16px">
    <div class="section-title">Información adicional de principales clientes</div>
    <div class="cards" id="cardsClientes"></div>
  </div>

  <div class="footnote" style="margin-top:12px">
    (1) Tasa de interés anual promedio de operaciones vigentes. (2) Días promedio YTD que normalmente permanece en mora.
  </div>
</div>

<script>
  // Colores base
  const C = {
    enFecha:"#1f3b26", vencido:"#86b88f", distressed:"#9aa6b2", inmovilizado:"#e5e7eb", caja:"#b0c4de",
    agro:"#1f3b26", coop:"#7bbf6a", cons:"#2c6cb0", otros:"#9aa6b2",
    accent:"#ffe54d"
  };

  // Helpers
  const fmtUSD = v => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v||0);
  const pct = (v,t) => t ? (v/t*100) : 0;

  let chEstatus, chSectores, chTopClientes, chValorCuota, chGarantias;

  // Renderers
  function legend(containerId, labels, colors, values, total){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    labels.forEach((lbl,i)=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `<span class="dot" style="background:${colors[i]}"></span>
                       <span>${lbl}</span>
                       <span style="margin-left:auto">${pct(values[i],total).toFixed(0)}%</span>`;
      el.appendChild(row);
    });
  }

  function renderBarsColocado(containerId, items){
    const wrap = document.getElementById(containerId);
    wrap.innerHTML = "";
    // encontrar max para escala
    const max = Math.max(...items.map(i => i.monto));
    items.forEach(i=>{
      const row = document.createElement('div'); row.className="bar-item";
      const label = document.createElement('div'); label.style.minWidth="180px"; label.textContent = i.nombre;
      const bar = document.createElement('div'); bar.className="bar"; bar.style.width = (i.monto/max*100).toFixed(1)+'%';
      const monto = document.createElement('div'); monto.style.marginLeft="auto"; monto.textContent = i.monto.toLocaleString('en-US');
      row.appendChild(label); row.appendChild(bar); row.appendChild(monto);
      wrap.appendChild(row);
    });
  }

  function renderCardsClientes(containerId, cards){
    const wrap = document.getElementById(containerId); wrap.innerHTML = "";
    cards.forEach(c=>{
      const box = document.createElement('div'); box.className="client-card";
      box.innerHTML = `
        <h4>${c.nombre}</h4>
        <div class="kpis">
          <div class="kpi-box"><div class="v">${c.tasa}%</div><div>Tasa de interés anual</div></div>
          <div class="kpi-box"><div class="v">${c.tasaMora}%</div><div>Tasa anual con mora</div></div>
          <div class="kpi-box"><div class="v">${c.diasMora}</div><div>Días prom. de mora</div></div>
          <div class="kpi-box"><div class="v">${c.deudaEnFecha}%</div><div>Deuda en fecha</div></div>
        </div>
        <div class="muted" style="margin-top:6px">Exposición actual ${fmtUSD(c.exposicion)}</div>
      `;
      wrap.appendChild(box);
    });
  }

  // Cargar datos y pintar todo
  function loadData(data){
    // Header
    const d = new Date(data.corte);
    const mes = d.toLocaleDateString('es-PE',{month:'long',year:'numeric'});
    const f = d.toLocaleDateString('es-PE');
    document.getElementById('label-mes').textContent = mes.charAt(0).toUpperCase()+mes.slice(1);
    document.getElementById('label-fecha').textContent = f;
    document.getElementById('label-fecha-2').textContent = f;

    // Rentabilidad
    document.getElementById('rentabilidad-kpi').textContent = ((data.rentabilidad12m||0)*100).toFixed(2)+'%';

    // Estatus donut
    const estLabels = ["En Fecha","Vencido","Compra Distressed","Inmovilizado","Caja"];
    const estVals = estLabels.map(k => data.estatus[k]||0);
    const estColors = [C.enFecha,C.vencido,C.distressed,C.inmovilizado,C.caja];
    if(chEstatus) chEstatus.destroy();
    chEstatus = new Chart(document.getElementById('chartEstatus'),{
      type:'doughnut',
      data:{labels:estLabels,datasets:[{data:estVals,backgroundColor:estColors}]},
      options:{cutout:'70%',plugins:{legend:{display:false},tooltip:{callbacks:{
        label:(ctx)=>`${ctx.label}: ${fmtUSD(ctx.raw)} (${pct(ctx.raw,data.total).toFixed(0)}%)`
      }}}}
    });
    document.getElementById('total-mm').textContent = (data.total/1_000_000).toFixed(1);
    legend('legendEstatus', estLabels, estColors, estVals, data.total);

    // Sectores donut
    const secLabels = Object.keys(data.sectoresActual);
    const secVals = secLabels.map(k=>data.sectoresActual[k]);
    const secColors = secLabels.map(k=>({"Agroindustria":C.agro,"Cooperativas Cafetaleras":C.coop,"Construcción":C.cons,"Otros":C.otros}[k]||C.otros));
    if(chSectores) chSectores.destroy();
    chSectores = new Chart(document.getElementById('chartSectores'),{
      type:'doughnut',
      data:{labels:secLabels,datasets:[{data:secVals,backgroundColor:secColors}]},
      options:{cutout:'60%',plugins:{legend:{display:false}}}
    });
    legend('legendSectores', secLabels, secColors, secVals, data.total);

    // Top clientes (pie)
    const top = data.topClientes;
    if(chTopClientes) chTopClientes.destroy();
    chTopClientes = new Chart(document.getElementById('chartTopClientes'),{
      type:'doughnut',
      data:{labels:top.labels,datasets:[{data:top.values,backgroundColor:[C.agro,C.coop,C.cons,'#8b8b8b','#c9cfd6','#a0a0a0']}]},
      options:{cutout:'55%',plugins:{legend:{display:false}}}
    });
    // lista otros
    const otros = document.getElementById('listaOtrosClientes'); otros.innerHTML="";
    data.otrosClientes.forEach(o=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<span>${o.nombre}</span><span>${o.pct.toFixed(1)}%</span>`;
      otros.appendChild(row);
    });

    // Valor Cuota (línea)
    if(chValorCuota) chValorCuota.destroy();
    chValorCuota = new Chart(document.getElementById('chartValorCuota'),{
      type:'line',
      data:{labels:data.valorCuota.labels,datasets:[{data:data.valorCuota.values, fill:false, tension:.2}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false}}}
    });
    document.getElementById('rn-ytd').textContent = (data.rentNetaYTD*100).toFixed(2)+'%';

    // Garantías (tabla + pie)
    const tgar = document.getElementById('tablaGarantias'); tgar.innerHTML="";
    data.garantias.lista.forEach(g=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<span>${g.nombre}</span><span>${g.miles.toLocaleString('en-US')} ( ${g.cubierto}x )</span>`;
      tgar.appendChild(row);
    });
    document.getElementById('cobertura-kpi').textContent = data.garantias.coberturaPct+'% de exposición';

    if(chGarantias) chGarantias.destroy();
    chGarantias = new Chart(document.getElementById('chartGarantias'),{
      type:'doughnut',
      data:{labels:data.garantiasPie.labels,datasets:[{data:data.garantiasPie.values,backgroundColor:['#7aa378','#86c391','#9ad0ab','#c2dfc4','#dfeee0','#8fb499','#b7c8b8','#e3f2e6']}]},
      options:{cutout:'55%',plugins:{legend:{display:false}}}
    });

    // Barras de Monto Colocado
    renderBarsColocado('barrasColocado', data.montoColocado);

    // Cards clientes
    renderCardsClientes('cardsClientes', data.cardsClientes);
  }

  // PDF
  document.getElementById('btn-pdf').addEventListener('click', ()=>{
    const element = document.getElementById('capture');
    html2pdf().set({
      margin:[10,10,10,10],
      filename:'GPD-OnePage.pdf',
      image:{type:'jpeg',quality:0.98},
      html2canvas:{scale:2,useCORS:true},
      jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    }).from(element).save();
  });

  // -------- DEMO DATA (sustituir por fetch a tu API o CSV) --------
  const total = 16_400_000;
  const demo = {
    corte:'2025-07-31',
    rentabilidad12m:0.2086,
    rentNetaYTD:0.0772,
    total,
    estatus:{ "En Fecha":0.64*total, "Vencido":0.17*total, "Compra Distressed":0.10*total, "Inmovilizado":0.04*total, "Caja":0.05*total },
    sectoresActual:{ "Agroindustria":0.75*total, "Construcción":0.14*total, "Cooperativas Cafetaleras":0.10*total, "Otros":0.01*total },
    topClientes:{ labels:["Inka’s Berries","Fideic. Gandules","Medanos","Libre Inmob.","Prosrela","Otros"], values:[30.7,9.1,8.3,8.8,5.8,16.8] },
    otrosClientes:[
      {nombre:"Agrícola Zaña", pct:6.4},{nombre:"FRG Farms", pct:4.1},{nombre:"Inm. Norte", pct:2.5},{nombre:"Quinta Blanca", pct:2.1},{nombre:"Apromayo", pct:1.5},{nombre:"Demás", pct:19.1}
    ],
    valorCuota:{ labels:["Sep-22","Nov-22","Ene-23","May-23","Sep-23","Ene-24","May-24","Sep-24","Ene-25","Mar-25","May-25","Jul-25"], values:[100,108.37,125.99,134.61,127.74,147.45,157.34,167.33,167.33,167.33,167.33,167.33] },
    garantias:{
      coberturaPct:77,
      lista:[
        {nombre:"Inka’s Berries", miles:4050, cubierto:"1.2x"},
        {nombre:"Fid. Gandules", miles:1680, cubierto:"1.8x"},
        {nombre:"Medanos", miles:1668, cubierto:"2.1x"},
        {nombre:"Libre Inmobil.", miles:1350, cubierto:"1.5x"},
        {nombre:"Proserla", miles:1300, cubierto:"1.2x"},
        {nombre:"Inm. Del Norte", miles:4145, cubierto:"5.7x"},
        {nombre:"Quinta Blanca", miles:350, cubierto:"1.5x"},
      ]
    },
    garantiasPie:{
      labels:["Inm. del Norte","Fid. Gandules","Los Medanos","Inka’s Berries","Libre Inmob.","Ag. Zaña","Quint. Blanca","Otros clientes"],
      values:[4000,3200,3209,2375,2452,1892,350,3944]
    },
    montoColocado:[
      {nombre:"Inka’s Berries", monto:5000000},
      {nombre:"Fideic. Gandules", monto:1680000},
      {nombre:"Medanos", monto:1515271},
      {nombre:"Libre Inmob.", monto:1350000},
      {nombre:"Proserla", monto:1300000},
      {nombre:"Otros", monto:5607555}
    ],
    cardsClientes:[
      {nombre:"Inka’s Berries", tasa:33.3, tasaMora:44.9, diasMora:4, deudaEnFecha:100, exposicion:5000000},
      {nombre:"Los Medanos", tasa:32.5, tasaMora:42.8, diasMora:12, deudaEnFecha:65, exposicion:1515271},
      {nombre:"Agrícola Zaña", tasa:42.0, tasaMora:46.8, diasMora:45, deudaEnFecha:94, exposicion:1073698},
      {nombre:"Proserla", tasa:26.8, tasaMora:39.3, diasMora:14, deudaEnFecha:100, exposicion:1300000},
      {nombre:"Otros clientes", tasa:31.0, tasaMora:38.4, diasMora:77, deudaEnFecha:79, exposicion:7899891}
    ]
  };

  // Si quieres conectar: fetch('/api/onepage?corte=2025-07-31').then(r=>r.json()).then(loadData);
  loadData(demo);
</script>
</body>
</html>